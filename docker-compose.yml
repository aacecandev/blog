version: "3.9"

services:
  api:
    build:
      context: ./src/backend
      dockerfile: Dockerfile
    command: uvicorn backend.main:app --host 0.0.0.0 --port 8000 --reload
    # user: "1000:1000"
    environment:
      DEV_BLOG_CONTENT_DIR: /app/content/posts
      DEV_BLOG_S3_BUCKET: ""
      DEV_BLOG_S3_PREFIX: ""
      DEV_BLOG_CACHE_TTL_SECONDS: 0
    volumes:
      - ./src/backend:/app/backend
      - ./content/posts:/app/content/posts:ro
    ports:
      - "8000:8000"
    networks:
      - dev-blog-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  web:
    build:
      context: ./src/frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: "http://localhost:8000"
    # user: "1000:1000"
    cap_add:
      - NET_BIND_SERVICE
    networks:
      - dev-blog-network
    ports:
      - "8080:80"
    depends_on:
      - api

networks:
  dev-blog-network:
    driver: bridge
